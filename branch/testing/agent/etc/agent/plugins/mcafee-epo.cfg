#McAfee EPO

# It's needed make the following query against the database to convert the IPs to a readable format.

#CREATE FUNCTION [dbo].[EpoIpToStr]
#(
#        @ipin int
#)
#RETURNS CHAR(15)
#AS
#BEGIN
#DECLARE @o1 bigint, @o2 bigint, @o3 bigint, @o4 bigint;
#DECLARE @ip bigint;
#        SET @ip = (CAST(@ipin as bigint) + 2147483647) + 1;
#        SET @o1 = @ip /16777216;
#        SET @ip = @ip % 16777216;
#        SET @o2 = @ip / 65536;
#        SET @ip = @ip % 65536;
#        SET @o3 = @ip / 256;
#        SET @ip = @ip % 256;
#        SET @o4 = @ip;
#        RETURN
#                CONVERT(VARCHAR(4), @o1) + '.' +
#                CONVERT(VARCHAR(4), @o2) + '.' +
#                CONVERT(VARCHAR(4), @o3) + '.' +
#                CONVERT(VARCHAR(4), @o4)
#END

[DEFAULT]
plugin_id=4008

[config]
type=detector
enable=yes

source=database
source_type=mssql
source_ip=
source_port=1433
user=sqluser
password=dbpass
db=EPO4
sleep=60

process=
start=no
stop=no

[start_query]
query="SELECT TOP 1 AutoID FROM EPOEvents ORDER BY AutoID DESC" 
regexp=

[query]
query="SELECT AutoID, CONVERT(nvarchar(40), AutoGUID), ServerID, DetectedUTC, rtrim(ltrim([dbo].[EpoIpToStr](SourceIPV4))), rtrim(ltrim([dbo].[EpoIpToStr](TargetIPV4))), TargetUserName, TargetFileName, ThreatCategory, ThreatEventID, ThreatSeverity, ThreatName FROM EPOEvents where AutoID > $1 ORDER BY AutoID"
regexp=
ref=0
plugin_sid={$9}
date={normalize_date($3)}
src_ip={$4}
dst_ip={$5}
filename={$6}
username={$5}
userdata1=GUID {$1}
userdata2=ServerID {$2}
userdata3=Severity {$10}
userdata4={$8}
userdata5={$11}
log={$11} 
