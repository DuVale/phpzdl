;; apache
;; plugin_id: 1501
;; 
;; $Id: apache.cfg,v 1.7 2010/02/24 21:30:47 juanmals Exp $
;;

[DEFAULT]
plugin_id=1501

# default values for dst_ip and dst_port
# they can be overwritten in each rule
dst_ip=\_CFG(plugin-defaults,sensor)
dst_port=80

[config]
type=detector
enable=yes

source=log
location=/var/log/%(process)s/access.log,/var/log/%(process)s/error.log

# create log file if it does not exists,
# otherwise stop processing this plugin
create_file=false

process=apache2     ; change by apache|httpd|etc.
start=yes   ; launch plugin process when agent starts
stop=no     ; shutdown plugin process when agent stops
startup=/etc/init.d/%(process)s start
shutdown=/etc/init.d/%(process)s stop

# list of sids (comma separated) to be excluded by the detector
exclude_sids=200

[translation]
emerg=1
alert=2
crit=3
error=4
warn=5
notice=6
info=7
debug=8

#
# Custom logs formats defined in apache2.conf
# To see variable definition: http://httpd.apache.org/docs/2.2/mod/mod_log_config.html#formats
#

[1 - apache-access]
#
# LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
# 10.101.101.166 - - [15/Mar/2011:15:18:34 +0100] "GET /824262.ppt HTTP/1.1" 404 432 "http://172.23.23.166/" "Mozilla/5.0 SF/1.84b"
#
# LogFormat "%v:%p %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" vhost_combined
# www1.alienvault.com:80 66.249.72.8 - - [11/Oct/2011:11:39:22 +0200] "GET /wiki/doku.php?id=anomalo&idx=user_manual_es HTTP/1.1" 200 4501 "-" "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)"
# www2.alienvault.com:80 87.216.160.114 - - [11/Oct/2011:11:58:28 +0200] "GET /forum/asdfasdfasdfasdfasdfasd HTTP/1.1" 404 379 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:6.0.2) Gecko/20100101 Firefox/6.0.2"

event_type=event
regexp=((?P<dst>\S+):(?P<port>\d{1,5}) )?(?P<src>\S+) (?P<id>\S+) (?P<user>\S+) \[(?P<date>\d{2}\/\w{3}\/\d{4}:\d{2}:\d{2}:\d{2})\s+[+-]\d{4}\] \"(?P<request>[^"]+[^"])\" (?P<code>\d{3}) (?P<size>\d+) \"(?P<referer_uri>.*)\" \"(?P<useragent>.*)\"$
src_ip={resolv($src)}
dst_ip={resolv($dst)}
dst_port={$port}
date={normalize_date($date)}
plugin_sid={$code}
username={$user}
userdata1={$request}
userdata2={$size}
userdata3={$referer_uri}
userdata4={$useragent}
filename={$id}


# Set the name of the file to which the server will log any errors
# it encounters:
#    ErrorLog /var/log/apache2/vhost1.error
# or enable logging via syslogd:
#    ErrorLog syslog
[2-apache-error]
#[Thu Aug 25 03:54:14 2011] [crit] [client 83.35.56.67] (13)Permission denied: /var/www/jdelacasa/autosuggest_v2.1.3/.htaccess pcfg_openfile: unable to check htaccess file, ensure it is readable
#[Fri Jan 14 11:14:16 2011] [crit] [client 62.83.42.80] configuration error:  couldn't perform authentication. AuthType not set!: /jdelacasa/show_pkt/show_update_repos.php
#[Thu Mar 12 12:16:42 2009] [error] [client 10.11.201.76] File does not exist: /usr/share/acidbase/images/bgbutton_on.gif, referer: http://192.168.23.5/ossim/forensics//styles/ossim_style.css
#[Mon Jul 11 21:55:07 2011] [error] [client 173.161.171.65] Directory index forbidden by Options directive: /var/www/feed/binary/
#[Mon Jul 11 22:08:39 2011] [error] [client 92.86.220.135] Invalid method in request \x16\x03\x01
#[Mon Jul 11 21:22:10 2011] [error] [client 196.210.213.164] Directory index forbidden by Options directive: /var/www/debian/
#[Mon Jul 11 09:07:32 2011] [warn] pid file /var/run/apache2.pid overwritten -- Unclean shutdown of previous Apache run?
#[Tue Sep 20 09:36:16 2011] [warn] child process 29465 still did not exit, sending a SIGTERM
#[Mon Jul 11 10:11:44 2011] [notice] Apache/2.2.9 (Debian) PHP/5.2.6-1+lenny13 with Suhosin-Patch mod_ssl/2.2.9 OpenSSL/0.9.8g mod_wsgi/2.5 Python/2.5.2 mod_perl/2.0.4 Perl/v5.10.0 configured -- resuming normal operations
#[Sat Aug 06 05:06:12 2011] [notice] child pid 5814 exit signal Segmentation fault (11)
#Oct 11 12:40:27 www1 apache2[14703]: [error] [client 192.168.1.7] File does not exist: /var/www/www.alienvault.com/images/stories/key.jpg, referer: http://www.alienvault.com/partners
#Oct  1 12:40:27 www1 apache2[14703]: [error] [client 192.168.1.7] File does not exist: /var/www/www.alienvault.com/images/stories/key.jpg, referer: http://www.alienvault.com/partners
#
event_type=event
regexp=(?P<date>(\w{3}\s\w{3}\s\d{2}:\d{2}:\d{2}\s\w{4})|(\w{3}\s+\d{1,2}\s\d{2}:\d{2}:\d{2}))(\]|\s).*\s\[(?P<type>(emerg|alert|crit|error|warn|notice|info|debug))\] (\[client (?P<src>\S+)\] )(?P<data>.*)
date={normalize_date($date)}
plugin_sid={translate($type)}
src_ip={$src}
userdata1={$data}

