;; sonicwall 
;; plugin_id: 1573
;; type: detector 
;; description: This checks the Sonicwall logs
;;              
;; Creator: Armando Machuca
;; Modified: ggrande and aarias

[DEFAULT]
plugin_id=1573

[config]
type=detector
enable=yes

source=log
location=/var/log/sonicwall.log

# create log file if it does not exists, 
# otherwise stop processing this plugin
create_file=false

process=
start=no   
stop=no
startup=
shutdown=

[translation]



## rules

[Rule-1 sonicwall ]
#Jan  3 13:45:36 192.168.5.1 id=firewall sn=000SERIAL time="2007-01-03 14:48:06" fw=1.1.1.1 pri=6 c=262144 m=98 msg="Connection Opened" n=23419 src=2.2.2.2:36701:WAN dst=1.1.1.1:50000:WAN proto=tcp/50000
#Jan  3 13:45:37 192.168.5.1 id=firewall sn=000SERIAL time="2007-01-03 14:48:07" fw=1.1.1.1 pri=6 c=1024 m=537 msg="Connection Closed" n=567996 src=192.168.4.10:27577:WAN dst=192.168.5.10:53:LAN proto=tcp/dns sent=257 rcvd=242
event_type=event
regexp="id=(?P<id>\S+)\s+.*?time=\"(?P<date>\d{4}-\d\d-\d\d \d\d(:|\s)?\d\d(:|\s)?\d\d).*?fw=(?P<sensor>\IPV4)\s+pri=(?P<priority>\d+).*?m=(?P<type>\d+).*?src=(?P<source>\IPV4):(?P<src_port>\PORT).*?dst=(?P<destination>\IPV4):(?P<dst_port>\d+).*proto=(?P<protocol>\w+).*"
date={normalize_date($date)}
plugin_sid={$type}
sensor={$sensor}
src_ip={$source}
dst_ip={$destination}
src_port={$src_port}
dst_port={$dst_port}
protocol={normalize_protocol($protocol)}
userdata1={$id}

[Rule-2 sonicwall - No protocol ]
#Jan  3 13:45:36 192.168.5.1 id=firewall sn=000SERIAL time="2007-01-03 14:48:06" fw=1.1.1.1 pri=6 c=262144 m=98 msg="Connection Opened" n=23419 src=2.2.2.2:36701:WAN dst=1.1.1.1:50000:WAN proto=tcp/50000
#Jan  3 13:45:37 192.168.5.1 id=firewall sn=000SERIAL time="2007-01-03 14:48:07" fw=1.1.1.1 pri=6 c=1024 m=537 msg="Connection Closed" n=567996 src=192.168.4.10:27577:WAN dst=192.168.5.10:53:LAN proto=tcp/dns sent=257 rcvd=242
event_type=event
regexp="id=(?P<id>\S+)\s+.*?time=\"(?P<date>\d{4}-\d\d-\d\d \d\d(:|s)?\d\d(:|s)?\d\d).*?fw=(?P<sensor>\IPV4)\s+pri=(?P<priority>\d+).*?m=(?P<type>\d+).*?src=(?P<source>\IPV4)(:|s)?(?P<src_port>\PORT).*?dst=(?P<destination>\IPV4)(:|s)?(?P<dst_port>\d+).*"
date={normalize_date($date)}
plugin_sid={$type}
sensor={$sensor}
src_ip={$source}
dst_ip={$destination}
src_port={$src_port}
dst_port={$dst_port}

[Rule-3 sonicwall - VPN access to dst_ip]
event_type=event
#Jul 22 10:26:22 syslog-ng@vpn.test.com logserver: [22/Jul/2010:10:26:22.790996 +0200] vpn 001719 ps 100000b2 Info    EWACL   User '(user.ext)@(Accesos Externos TEST.COM) (CN=John Doe,OU=AEmpresasExternas,DC=test,DC=com)' connecting from '10.128.248.113:12527' matched rule #2 'URL PDPCM', access to '10.15.187.235:8080' is permitted.
regexp="(\S+\s\S+\s\S+)\s(?P<device_id>\S+).*User\s\'(.*)\'\sconnecting\sfrom\s\'(?P<src_ip>\S+):(?P<src_port>\S+)\'.*\'(?P<dst_ip>\S+):(?P<dst_port>\S+)\'.*"
plugin_sid=1103
src_ip={$src_ip}
src_port={$src_port}
dst_ip={$dst_ip}
dst_port={$dst_port}
userdata1={$error}
plugin_sid=1103

[Rule-4 sonicwall - VPN access to dest_ip error]
event_type=event
#Jul 22 12:17:20 syslog-ng@vpn.test.com logserver: [22/Jul/2010:12:17:20.681166 +0200] vpn 000000 kt 00000000 Info    Session Src='10.15.173.5:3873' Auth='-' User='(usertest)@(Accesos trabajadores de TEST.COM) (CN=John Doe,OU=Siemens,OU=Entidad,OU=Informatica,DC=test,DC=com)' SocksVersion='0x101' Command='Flow:TCP' Dest='10.10.6.30:445' Error='0xffffff92' SrcBytes='48' DstBytes='0' Duration='63' VirtualHost='-' EquipmentId='-'
regexp="(\S+\s\S+\s\S+)\s(?P<device_id>\S+).*Session\s\Src=\'(?P<src_ip>\S+):(?P<src_port>\S+)\'\sAuth=\'(\S+)\'\sUser=\'(?P<user>.*)\'\s.*Dest=\'(?P<dst_ip>\S+):(?P<dst_port>\S+)\'\sError=\'(?P<error>\S+)\'.*"
date={normalize_date($1)}
#sensor={resolv($device_id)}
plugin_sid=1102
src_ip={$src_ip}
src_port={$src_port}
dst_ip={$dst_ip}
dst_port={$dst_port}
userdata1={$error}
plugin_sid=1102

[Rule-5 sonicwall - VPN access]
event_type=event
#Jul 22 10:26:23 syslog-ng@vpn.test.com logserver: [22/Jul/2010:10:26:23.340515 +0200] vpn 001719 ps 100000b7 Info    Session Authentication Restore for user '(usertest.ext)@(Accesos Externos TEST.COM) (CN=John Doe,OU=AEmpresasExternas,DC=test,DC=com)' SUCCESS
regexp="(\S+\s\S+\s\S+)\s(?P<device_id>\S+).*\'(?P<msg>.*)\'\s"
date={normalize_date($1)}
sensor={resolv($device_id)}
plugin_sid=1101

[Rule-6 sonicwall ]
May 12 07:48:58 id=firewall sn=0017C508C09C time="2011-05-12 07 49 47" fw=173.161.171.65 pri=5 c=0 m=760 msg="TCP handshake violation detected TCP connection dropped" n=0 src=172.22.14.150 42319 LAN dst=74.206.189.96 3310 WAN note="Handshake Timeout"
event_type=event
regexp="\w+\s+\d+\s+\d+:\d+:\d+\s+id=(?P<id>\w+)\s+.*\s+time=\"(?P<date>\d+-\d+-\d+\s+\d+(:|\s+)\d+(:|\s+)\d+)\"\s+fw=(?P<sensor>\S+)\s+pri=(?P<priority>\d+).*m=(?P<type>\d+).*src=(?P<source>\S+)(?P<src_port>\d+).*dst=(?P<destination>\S+)\s+(?P<dst_port>\d+).*note=\"(?P<note>\w+\s+\w+).*"
date={normalize_date($date)}
plugin_sid={$type}
sensor={$sensor}
src_ip={$source}
dst_ip={$destination}
src_port={$src_port}
dst_port={$dst_port}
userdata1={$id}
userdata2={$note}

[Rule-7 sonicwall ]
#May 12 07:58:14 id=firewall sn=0017C508C09C time="2011-05-12 07 59 01" fw=10.161.171.65 pri=5 c=64 m=36 msg="TCP connection dropped" n=0 src=10.70.75.34 47377 WAN dst=10.161.171.64 80 WAN proto=tcp/http
event_type=event
regexp="id=(?P<id>\S+)\s+.*?time=\"(?P<date>\d+-\d+-\d+\s+\d+(:|\s+)\d+(:|\s+)\d+).*?fw=(?P<sensor>\d+.\d+.\d+.\d+)\s+pri=(?P<priority>\d+).*?m=(?P<type>\d+).*?src=(?P<source>\d+.\d+.\d+.\d+)\s+(?P<src_port>\d+).*?dst=(?P<destination>\d+.\d+.\d+.\d+)\s+(?P<dst_port>\d+).*proto=(?P<protocol>\w+).*"
date={normalize_date($date)}
plugin_sid={$type}
sensor={$sensor}
src_ip={$source}
dst_ip={$destination}
src_port={$src_port}
dst_port={$dst_port}
protocol={normalize_protocol($protocol)}
userdata1={$id}

[Rule-8 sonicwall ]
#May 13 09:18:20 id=firewall sn=0017C508C09C time="2011-05-13 09:19:09" fw=10.161.171.65 pri=6 c=16 m=237 msg="VPN zone remote user login allowed" n=0 src=10.166.106.164:WAN: dst=10.161.171.65:0:WAN: proto=tcp/0
event_type=event
regexp="\w+\s+\d+\s+\d+:\d+:\d+\s+id=(?P<id>\w+)\s+.*\s+time=\"(?P<date>\d+-\d+-\d+\s+\d+(:|\s+)\d+(:|\s+)\d+)\"\s+fw=(?P<sensor>\d+.\d+.\d+.\d+)\s+pri=(?P<priority>\d+).*m=(?P<type>\d+).*src=(?P<source>\d+.\d+.\d+.\d+).*dst=(?P<destination>\d+.\d+.\d+.\d+).*proto=(?P<protocol>\w+).*"
date={normalize_date($date)}
plugin_sid={$type}
sensor={$sensor}
src_ip={$source}
dst_ip={$destination}
protocol={normalize_protocol($protocol)}
userdata1={$id}
