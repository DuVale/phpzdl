;; Vmware Vcenter
;;

[DEFAULT]
plugin_id=1658

[config]
enable=yes
type=detector

source=log
location=/var/log/vmware-vcenter.log

# create log file if it does not exists,
# otherwise stop processing this plugin
create_file=false

process=
start=no    ; launch plugin process when agent starts
stop=no     ; shutdown plugin process when agent stops
startup=
shutdown=

[translation]
Accepted=2
Failed=3
opened=4
closed=5
disconnected=6
dissociate=7
disabled=8

[VMware Vcenter - Virtual machine start]
#Aug 31 10:10:10 192.168.1.1 xinetd[4787]: START: vmware-authd pid=17922 from=192.168.1.2
regexp="(?P<date>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<sip>\d+.\d+.\d+.\d+)\s+(?P<service>\w+)(\[\d+\])?:\s+(?P<msg>START):\s+(?P<process>.*)\s+pid=(?P<pid>\d+)\s+from=(?P<sip_body>\d+.\d+.\d+.\d+)"
event_type=event
plugin_sid=1
src_ip={resolv($sip_body)}
date={normalize_date($date)}
userdata1={$msg}
userdata2={$service}
userdata3={$process}
userdata4={$pid}

[VMware Vcenter - Authentication]
#Aug 31 10:10:10 192.168.1.1 sshd[19655]: Accepted password for johndoe from 192.168.1.2 port 1234 ssh2
#Aug 31 10:10:10 192.168.1.1 sshd[19855]: Failed password for johndoe from 192.168.1.2 port 1234 ssh2
event_type=event
regexp="(?P<date>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<sip>\d+.\d+.\d+.\d+)\s+(?P<service>\w+)(\[\d+\])?:\s+(?P<msg>(?P<sid>Accepted|Failed).*)\sfor\s(?P<user>.*)\sfrom\s(?P<sip_body>.*)\s+port\s+(?P<sport>\d+)\s"
plugin_sid={translate($sid)}
src_ip={resolv($sip_body)}
src_port={$sport}
date={normalize_date($date)}
username={$user}
userdata1={$msg}
userdata2={$service}

[VMware Vcenter - Authentication failure]
#Aug 31 10:10:10 192.168.1.1 sshd[19855]: pam_unix(system-auth-generic:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=192.168.1.2  user=johndoe
event_type=event
regexp="(?P<date>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<sip>\d+.\d+.\d+.\d+)\s+(?P<service>\w+)(\[\d+\])?:\s+pam_unix.*:\s+(?P<msg>.*);.*rhost=(?P<sip_body>.*)\s+user=(?P<user>\w+)"
plugin_sid=3
src_ip={resolv($sip_body)}
date={normalize_date($date)}
username={$user}
userdata1={$service}
userdata2={$msg}

[VMware Vcenter - Session]
#Aug 31 10:10:10 192.168.1.1 sshd[19655]: pam_unix(system-auth-generic:session): session opened for user johndoe by (uid=0)
#Aug 31 10:10:10 192.168.1.1 sshd[19655]: pam_unix(system-auth-generic:session): session closed for user johndoe
event_type=event
regexp="(?P<date>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<sip>\d+.\d+.\d+.\d+)\s+(?P<service>\w+)(\[\d+\])?:\s.*:\s+(?P<msg>session\s(?P<sid>opened|closed))\s+.*user\s+(?P<user>\w+).*"
plugin_sid={translate($sid)}
src_ip={resolv($sip)}
date={normalize_date($date)}
username={$user}
userdata1={$service}
userdata2={$msg}

[VMware Vcenter - Virtual machine disconnected]
#Aug 31 10:10:10 192.168.1.1 vmkernel: 19:17:22:49.226 cpu53:4188)Net: 1234: disconnected client from port 0x30000b1
#Aug 31 10:10:10 192.168.1.1 vmkernel: 19:17:22:49.226 cpu53:4188)Net: 1234: dissociate dvPort 308 from port 0x30000b2
#Aug 31 10:10:10 192.168.1.1 vmkernel: 19:17:22:49.226 cpu53:4188)NetPort: 1234: disabled port 0x30000b1
event_type=event
regexp="(?P<date>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<sip>\d+.\d+.\d+.\d+)\s+(?P<service>\w+)(\[\d+\])?:\s+.*cpu.*Net.*\d+:\s(?P<sid>\w+)\s"
plugin_sid={translate($sid)}
src_ip={resolv($sip)}
date={normalize_date($date)}
userdata1={$service}

[VMware Vcenter -zzz- Generic rule]
event_type=event
regexp="(?P<date>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<sip>\d+.\d+.\d+.\d+)\s+(?P<service>\w+)(\[\d+\])?:\s+(?P<msg>.*)\n"
date={normalize_date($date)}
plugin_sid=1999999999
src_ip={$sip}
userdata1={$service}
userdata2={$msg}
